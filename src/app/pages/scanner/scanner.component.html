<div class="shell">
  <header class="header">
    <h2>Lector de Códigos</h2>
    <button (click)="auth.logout()">Salir</button>
  </header>

  <section class="controls">
    <label>
      Cámara:
      <select [(ngModel)]="selectedDevice">
        <option *ngFor="let d of devices" [ngValue]="d">
          {{ d.label || d.deviceId }}
        </option>
      </select>
    </label>
    <button (click)="toggleTorch()">Linterna {{ torchOn ? 'ON' : 'OFF' }}</button>
  </section>

  <div class="scanner-wrap">
    <!-- Overlay para apuntar al área superior/central del papel -->
    <div class="overlay">
      <div class="guide">
        <span>Apunta aquí (arriba/centro)</span>
      </div>
    </div>

    <zxing-scanner
      [device]="selectedDevice || undefined"
      [formats]="formats"
      (scanSuccess)="onScanSuccess($event)"
      (scanError)="onScanError($event)"
      (camerasFound)="onCamerasFound($event)"
      (hasDevices)="onHasDevices($event)"
      [torch]="torchOn"
      [tryHarder]="true"
      class="preview"
    ></zxing-scanner>
  </div>

  <section class="result">
    <h3>Lectura</h3>
    <div *ngIf="lastResult; else noResult">
      <p><b>Bruto:</b> <code>{{ lastResult }}</code></p>
      <div *ngIf="lastParsed; else invalid">
        <h4>Identificado</h4>
        <ul>
          <li><b>Serie:</b> {{ lastParsed.serie }}</li>
          <li><b>Empresa:</b> {{ lastParsed.empresa }}</li>
          <li><b>No.Doc:</b> {{ lastParsed.noDoc }}</li>
          <li><b>Lote (posible):</b> {{ lastParsed.lote }}</li>
          <li><b>Planta:</b> {{ lastParsed.planta }}</li>
          <li><b>Envío (posible):</b> {{ lastParsed.envio }}</li>
        </ul>
      </div>
      <ng-template #invalid>
        <p class="warn">El código leído no coincide con el patrón esperado <code>J5-STR-######-#####-#####-######</code>.</p>
      </ng-template>
    </div>
    <ng-template #noResult>
      <p class="muted">Aún no hay lectura.</p>
    </ng-template>
  </section>
</div>
